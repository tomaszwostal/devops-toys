apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: grafana-loki
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - cluster: local
        url: https://kubernetes.default.svc
  template:
    metadata:
      name: '{{cluster}}-grafana-loki'
    spec:
      project: monitoring
      destination:
        namespace: loki
        server: '{{url}}'
      source:
        repoURL: https://grafana.github.io/helm-charts
        chart: loki-distributed
        targetRevision: 0.*.*
        helm:
          releaseName: grafana-loki
          values: |-
            nameOverride: "grafana-loki"
            fullnameOverride: "grafana-loki"
            serviceMonitor:
              enabled: true
            ingester:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            distributor:
              # extraArgs:
              #   - '-config.expand-env=true'
              # extraEnvFrom:
              #   - minio-creds
            querier:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            querierFrontend:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            queryScheduler:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            tableManager:
              enabled: false
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            gateway:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
              enabled: true
              basicAuth:
                enabled: true
                existingSecret: loki-gateway-auth
              ingress:
                enabled: true
                ingressClassName: nginx
                annotations:
                  cert-manager.io/cluster-issuer: devops-local
                hosts:
                  - host: loki.devops.local
                    paths:
                      - path: /
                        pathType: ImplementationSpecific
                tls:
                  - secretName: loki-gateway-tls
                    hosts:
                      - loki.devops.local
            compactor:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            ruler:
              enabled: true
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
              directories:
                devops-toys:
                  rules1.txt: |
                    groups:
                      - name: should_fire
                        rules:
                          - alert: HighPercentageError
                            expr: |
                              sum(rate({app="foo", env="production"} |= "error" [5m])) by (job)
                                /
                              sum(rate({app="foo", env="production"}[5m])) by (job)
                                > 0.05
                            for: 10m
                            labels:
                              severity: warning
                            annotations:
                              summary: High error rate
                      - name: credentials_leak
                        rules:
                          - alert: http-credentials-leaked
                            annotations:
                              message: "{{ $labels.job }} is leaking http basic auth credentials."
                            expr: 'sum by (cluster, job, pod) (count_over_time({namespace="prod"} |~ "http(s?)://(\\w+):(\\w+)@" [5m]) > 0)'
                            for: 10m
                            labels:
                              severity: critical
            indexGateway:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
            memcachedExporter:
              enabled: true

            loki:
              extraArgs:
                - '-config.expand-env=true'
              extraEnvFrom:
                - minio-creds
              config: |
                auth_enabled: true
                common:
                  compactor_address: {{ include "loki.compactorFullname" . }}:3100

                schema_config:
                  configs:
                  - from: 2020-05-15
                    store: boltdb-shipper
                    object_store: s3
                    schema: v11
                    index:
                      prefix: loki_index_
                      period: 24h

                storage_config:
                  boltdb_shipper:
                    active_index_directory: /var/loki/index
                    cache_location: /var/loki/cache
                    cache_ttl: 24h
                    shared_store: s3

                  aws:
                    s3: s3://${accesskey}:${secretkey}@minio.minio.svc.cluster.local:9000
                    s3forcepathstyle: true
                    bucketnames: loki

                frontend_worker:
                  {{- if .Values.queryScheduler.enabled }}
                  scheduler_address: {{ include "loki.querySchedulerFullname" . }}:9095
                  {{- else }}
                  frontend_address: {{ include "loki.queryFrontendFullname" . }}-headless:9095
                  {{- end }}

                distributor:
                  ring:
                    kvstore:
                      store: memberlist

                compactor:
                  working_directory: /var/loki/compactor
                  shared_store: s3

                memberlist:
                  join_members:
                    - {{ include "loki.fullname" . }}-memberlist

                ingester_client:
                  grpc_client_config:
                    grpc_compression: gzip

                ingester:
                  lifecycler:
                    ring:
                      kvstore:
                        store: memberlist
                      replication_factor: 1
                  chunk_idle_period: 30m
                  chunk_block_size: 262144
                  chunk_encoding: snappy
                  chunk_retain_period: 1m
                  max_transfer_retries: 0
                  wal:
                    dir: /var/loki/wal

                ruler:
                  storage:
                    type: s3
                    s3:
                      s3: s3://minioadmin:minioadmin@minio.minio.svc.cluster.local:9000/loki-rules
                      s3forcepathstyle: true

      syncPolicy:
        automated:
          selfHeal: true
          prune: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=false

